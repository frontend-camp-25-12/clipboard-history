"use strict";const F=require("electron-store"),d=require("clipboard-event"),I=require("electron-clipboard-ex"),{clipboard:f,nativeImage:S,shell:P}=require("electron"),u=require("fs"),p=require("path"),a=new F({name:"clipboard-history-plugin",defaults:{history:[],settings:{enableAudio:!0,shouldCapture:!0,theme:"system"}}});let l=[];const _=[".png",".jpg",".jpeg",".gif",".bmp",".webp",".tiff",".svg"],E=5*1024*1024,x=1e5,b={success:p.join(__dirname,"./src/assets/sounds/success.mp3"),error:p.join(__dirname,"./src/assets/sounds/error.mp3"),trash:p.join(__dirname,"./src/assets/sounds/trash.mp3"),copy:p.join(__dirname,"./src/assets/sounds/copy.mp3")};console.log("音频路径验证:",{success:u.existsSync(b.success),error:u.existsSync(b.error)});function g(t){if(a.get("settings").enableAudio)try{new Audio(b[t]).play().catch(r=>{r.name==="NotAllowedError"?console.warn("播放被用户阻止，请检查浏览器设置"):console.error("播放失败:",r)})}catch(s){console.error("创建音频对象失败:",s)}}function m(t,e){return Array.isArray(t)&&Array.isArray(e)?t.length===e.length&&t.every((s,r)=>s===e[r]):t===e}function L(){const t=process.platform==="win32",e=process.platform==="darwin",s=new Date().toISOString(),r=I.readFilePaths();let i=null;if(t||e)if(r.length>1)m(l,r)||(l=r,i={type:"file",content:r,timestamp:s,isImage:!1,star:!1},console.log("检测到剪贴板变更:",r));else{let n=!1;const h=f.readImage("clipboard");if(!h.isEmpty()){const o=h.toDataURL();o.startsWith("data:image/")&&o.length>50&&(m(o,l)||(l=o,i={type:"image",content:o,timestamp:s,preview:o,star:!1},n=!0))}if(!n&&f.has("FileNameW"))try{const c=f.readBuffer("FileNameW").toString("ucs2").replace(/\0/g,"");if(c&&c.length>0&&c!==l){l=c;const A=p.extname(c).toLowerCase();if(_.includes(A)&&u.existsSync(c))try{if(u.statSync(c).size<=E){const y=S.createFromPath(c).toDataURL();y&&(i={type:"image",content:y,timestamp:s,preview:y,star:!1},n=!0)}}catch(w){console.error("读取图片文件失败:",w)}n||(i={type:"file",content:c,timestamp:s,isImage:!1,star:!1},n=!0)}}catch(o){console.error("读取 FileNameW 失败:",o)}if(!n){const o=f.readText();o&&!m(o,l)&&(l=o,i={type:"text",content:o,timestamp:s,star:!1})}}return i}const j={getStorageSize:()=>{const t=a.path;try{return u.statSync(t).size}catch(e){return console.error("获取存储文件大小失败:",e),0}},getHistory:()=>a.get("history",[]),getSettings:()=>a.get("settings",{}),updateSettings:t=>{console.log("Updating Store:",t),a.set("settings",t)},deleteItem:t=>{let e=a.get("history",[]);return e=e.filter(s=>s.timestamp!==t),a.set("history",e),e},clearHistory:()=>(a.set("history",[]),g("trash"),[]),toggleStar:t=>{let e=a.get("history",[]);const s=e.findIndex(r=>r.timestamp===t);return s!==-1&&(e[s].star=!e[s].star,a.set("history",e)),e},copyToClipboard:(t,e)=>{try{switch(t){case"text":f.writeText(e),g("copy");break;case"image":if(e.startsWith("data:image")){const s=S.createFromDataURL(e);f.writeImage(s),g("copy")}else{const s=S.createFromPath(e);f.writeImage(s),g("copy")}break;case"file":typeof e=="string"?(I.writeFilePaths([e]),g("copy")):Array.isArray(e)&&(I.writeFilePaths(e),g("copy"));break;default:console.warn(`未知的复制类型: ${t}`)}}catch(s){console.error("复制到剪贴板失败:",s)}},startClipboardListening:t=>{d.startListening();const e=()=>{try{const s=a.get("settings");if(!s.shouldCapture)return;const r=L();if(r!==null){let i=a.get("history",[]);const n=i.findIndex(h=>h.type===r.type&&h.content===r.content);n!==-1&&i.splice(n,1),i.unshift(r),s.enableAudio&&g("success"),i.length>x&&(i=i.slice(0,x)),a.set("history",i),t&&t(i)}}catch(s){console.error("changeHandler 执行失败:",s)}};return d.on("change",e),()=>{d.stopListening()}},checkFileExists:t=>{try{return u.existsSync(t)}catch(e){return console.error("检查文件存在失败:",e),!1}},openFile:t=>{try{P.openPath(t).then(e=>{e&&console.error("打开文件失败:",e)})}catch(e){console.error("打开文件失败:",e)}}};window.clipboardPlugin=j;
